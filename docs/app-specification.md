# 競走馬血統表アプリケーション「GalloPedia」仕様書

## 1. 概要

本アプリケーションは、競走馬の血統情報を視覚的に表示し、検索機能を提供するWebアプリケーションです。ユーザーは特定の競走馬の血統的背景を容易に確認でき、様々な条件での検索が可能です。すべての処理はブラウザ上で完結し、SQLite WASMを利用してフロントエンドでデータベースを操作します。

## 2. システム構成

### 2.1 技術スタック

- **フロントエンド**
  - 開発環境: Next.js
  - UI フレームワーク: React
  - スタイリング: TailwindCSS
  - データベース: SQLite3（WebAssembly版）
  - テスト: Vitest

- **デプロイメント**
  - Github Pages

### 2.2 システムアーキテクチャ

本アプリケーションはクライアントサイドのみで完結するシングルページアプリケーション（SPA）です。

```
[ユーザー] <-> [Webブラウザ] <-> [React UI] <-> [SQLite WASM]
                                        ↓
                               [静的ファイル (Github Pages)]
```

- ユーザーはブラウザ経由でアプリケーションにアクセス
- すべての処理はブラウザ内で実行
- SQLite WASMを使用してブラウザ内でSQLiteデータベースを操作
- 初期データはプリロードされたSQLiteファイルから読み込み

## 3. データベース設計

割愛

## 4. 機能仕様

### 4.1 血統表示機能

#### 4.1.1 基本表示

- 選択した馬を中心として、父系・母系の血統を表示
- 標準で3世代表示（父母、祖父母、曾祖父母）
- 各馬の基本情報（名前、生年、毛色など）を表示
- 血統関係を線または矢印で視覚的に表現

#### 4.1.2 詳細表示

- 馬をクリックすると詳細情報を表示
- 詳細情報には基本情報に加え、主な戦績を表示
- 可能な場合は馬の写真を表示

#### 4.1.3 表示カスタマイズ

- 表示世代数の変更（1〜3世代）
- テーマ切り替え（ライト/ダーク）

### 4.2 検索機能

#### 4.2.1 馬名検索

- 馬名による部分一致検索
- 日本語名/英語名どちらでも検索可能
- 検索結果から馬を選択して血統表示へ遷移

#### 4.2.2 詳細検索

- 生年による絞り込み
- 性別による絞り込み
- 毛色による絞り込み
- 産地/生産国による絞り込み
- G1勝利馬のみ表示などの条件設定

#### 4.2.3 血統検索

- 特定の血統を持つ馬の検索
  - 例: 「ディープインパクト産駒」「サンデーサイレンス系」など
- 父系/母系の指定
- 世代数の指定（子、孫、など）

### 4.3 データ管理機能

#### 4.3.1 データインポート

- CSVからのデータインポート
- 既存のSQLiteファイルのインポート

#### 4.3.2 データエクスポート

- 現在のデータベースをエクスポート（SQLiteファイル）
- 検索結果をCSVとしてエクスポート

### 4.4 UI/UX仕様

#### 4.4.1 メイン画面構成

- ヘッダー（アプリ名、検索バー、設定メニュー）
- メインコンテンツ領域（血統表示/検索結果）
- フッター（アプリ情報）

#### 4.4.2 血統表示画面

- 階層型の血統図表示
- 馬の情報カード
  - 名前
  - 生年
  - 性別
  - 毛色
  - 主な成績（G1勝利数など）
- 親子関係の線
- 詳細表示モーダル/サイドパネル

#### 4.4.3 検索画面

- 検索フォーム領域
  - テキスト入力
  - 各種フィルターオプション
- 検索結果一覧
  - 馬のリスト表示
  - 簡易情報表示
  - クリックで詳細表示

#### 4.4.4 レスポンシブ対応

- デスクトップ（1200px以上）
  - フル機能表示
  - 3世代まで一度に表示
- タブレット（768px〜1199px）
  - 若干簡略化された表示
  - スクロールで全体閲覧
- モバイル（767px以下）
  - 簡略化された表示
  - アコーディオン/タブ形式での世代表示

## 5. 実装詳細

### 5.1 データ処理フロー

1. アプリケーション初期化時
   - SQLite WASMの初期化
   - Origin Private File Systemの初期化
   - 初期データベースのロード（存在しない場合は新規作成）
   - 設定の適用

2. 血統表示処理
   - ユーザーが馬を選択
   - 選択された馬のIDを基に血統検索クエリを実行
   - 結果をツリー構造に変換
   - 血統図としてレンダリング

3. 検索処理
   - ユーザーが検索条件を入力
   - 条件に基づいたSQLクエリを構築
   - クエリ実行結果を一覧表示

### 5.2 主要コンポーネント構成

```
/src
  /components
    /layout
      - AppHeader.jsx       # アプリヘッダー
      - AppFooter.jsx       # アプリフッター
    /pedigree
      - PedigreeChart.jsx   # 血統図表示コンポーネント
      - HorseCard.jsx       # 馬情報カード
      - PedigreeTreeView.jsx # 血統ツリー表示
    /search
      - SearchForm.jsx      # 検索フォーム
      - SearchResults.jsx   # 検索結果一覧
      - DetailedSearch.jsx  # 詳細検索フォーム
    /data
      - ImportExport.jsx    # データインポート/エクスポート
  /hooks
    - useDatabase.js        # データベース操作カスタムフック
    - usePedigree.js        # 血統データ処理カスタムフック
    - useSearch.js          # 検索処理カスタムフック
  /utils
    - sqlQueries.js         # SQL クエリ関数
    - dataFormatters.js     # データフォーマット関数
  /pages
    - Home.jsx              # ホーム画面
    - PedigreePage.jsx      # 血統表示画面
    - SearchPage.jsx        # 検索画面
  /contexts
    - DatabaseContext.jsx   # データベースコンテキスト
    - SettingsContext.jsx   # 設定コンテキスト
  - App.jsx                 # メインアプリコンポーネント
  - main.jsx                # エントリーポイント
```

## 6. テスト計画

### 6.1 単体テスト

- **テスト対象**: 各コンポーネント、カスタムフック、ユーティリティ関数
- **使用ツール**: Vitest
- **主要テスト項目**:
  - SQLクエリ関数の正常動作確認
  - データフォーマット関数の正常動作確認
  - カスタムフックの状態管理確認
  - コンポーネントのレンダリング確認

### 6.2 統合テスト

- **テスト対象**: 機能間の連携
- **使用ツール**: Vitest + React Testing Library
- **主要テスト項目**:
  - 検索から血統表示までの流れ
  - データインポート/エクスポート機能
  - 設定変更の反映

### 6.3 ブラウザ互換性テスト

- **テスト対象**: 主要ブラウザでの動作確認
- **対象ブラウザ**:
  - Chrome
  - Firefox
  - Safari
  - Edge
- **確認項目**:
  - レンダリングの正確性
  - パフォーマンス
  - SQLite WASM対応状況

### 6.4 レスポンシブデザインテスト

- **テスト対象**: 異なる画面サイズでの表示
- **確認項目**:
  - レイアウトの崩れがないか
  - 機能の利用に問題がないか
  - 表示/非表示の切り替えが適切か

## 7. デプロイメント計画

### 7.1 ビルドプロセス

1. `npm run build`でプロダクションビルドを作成
2. ビルド成果物（`dist`ディレクトリ）を準備
3. 初期データベースファイルを`public`ディレクトリに配置

### 7.2 Github Pagesへのデプロイ

1. Github Actionsでデプロイ

### 7.3 更新計画

- 新しいデータのみを差分更新
- 更新内容をリリースノートとして公開

## 8. 今後の拡張計画

以下の機能は将来的な拡張として検討されています：

- 血統の統計分析機能
- 複数の馬の血統比較機能
- 詳細な競走成績表示機能
- SNSへの共有機能

## 9. 注意事項と制約

- オフライン対応のため、データはOrigin Private File Systemを使ってローカル領域にSQLiteファイルごと保存
- 大量のデータを扱うため、パフォーマンス最適化が重要
- ブラウザのSQLite WASMとOrigin Private File System対応状況による制約
- モバイルデバイスのメモリ制約を考慮した実装が必要
